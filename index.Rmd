---
title: "**Rock-art** on multi-paradigm <br> and multi-scalar open-source app"
abstract: "A web presentation of rock-art data and 3D mapping" 
author: "Thomas Huet"
# date: "4/26/2021"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r, echo=FALSE}
url.root <- "https://raw.githubusercontent.com/zoometh/thomashuet/main/img/"
htmltools::img(src = paste0(url.root, "prj_rockart.png"), 
               alt = 'logo', 
               width = '150px',
               style = 'position:absolute; top:0; right:0; padding:10px;')
```

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(RPostgreSQL)
library(RPostgres)
library(httr)
library(english)
```

# Presentation

The mount Bego region (Alpes-Maritimes, France) is almost known for its rock-art with some impressive engraved rocks, but the site is also one of the earliest  occupation of mountains dated to the early Neolithic of (ca. -5300 BC)

# Read the data

Currently the data are stored in a local Postgres 13 database. Here, we select few field -- including the geographical coordinates -- and export them into a `.csv` file stored in the GitHub repository

```{r loaddb, eval=F}
drv <- dbDriver("PostgreSQL")
con <- dbConnect(RPostgres::Postgres(),
                 dbname = "bego_20_04_2021",
                 host="localhost",
                 port=5433,
                 user="postgres",
                 password="postgres")  
sqll <- "SELECT idroche, nom, x, y, z FROM roches_spat"
roches.all <- dbGetQuery(con,sqll)
roches.all$idroche <- gsub("\\.", "\\_", roches.all$idroche )
write.csv(roches.all, "data/roches_all.csv", row.names = F)
dbDisconnect(con)
```

Some engraved rocks have been modeled in 3D with photogrammetry. These 3D models are handle with the [3DHOP framework](http://www.3dhop.net/) and stored into the GitHub forked repository [zoometh/3DHOP](https://github.com/zoometh/3DHOP/tree/master/minimal). In the next code chunk, we read the content of the 'minimal' folder to get the names of these models (stored as `.nxz` files in the 'models' folder)

```{r read}
roches.all <- read.csv("data/roches_all.csv")
req <- GET("https://api.github.com/repos/zoometh/3DHOP/git/trees/master?recursive=1")
stop_for_status(req)
filelist <- unlist(lapply(content(req)$tree, "[", "path"), use.names = F)
D3.models <- grep("minimal/.*html$", filelist, value = TRUE)
D3.models <- gsub("minimal/", "", D3.models)
D3.models <- gsub(".html$", "", D3.models)
```
Currently, there is `r as.english(length(D3.models))` 3D models: `r D3.models`.

# Plot the map

We link the URLs of engraved rocks modeled in 3D with the appropriate rows in the dataset -- to open them directly from the leaflet map --, and we assign to these rocks a custom icon (3DHOP icon)

```{r mapleaflet}
D3HOP.root <- "https://zoometh.github.io/3DHOP/minimal/"
roches.3D <- roches.all[roches.all$idroche %in% D3.models, ]
roches.others <- roches.all[!(roches.all$idroche %in% D3.models), ]
roches.3D.icons <- icons(
  iconUrl = "https://raw.githubusercontent.com/zoometh/rockart/main/www/icon_3dhop.png",
  iconWidth = 40, iconHeight = 56,
  iconAnchorX = 20, iconAnchorY = 28
)
roches.3D$desc <- paste0("roche: ", roches.3D$idroche, '<br> 3D model: <a href=',
                         shQuote(paste0(D3HOP.root, roches.3D$idroche, ".html")),
                         "\ target=\"_blank\"",">", roches.3D$nom, "</a>")
roches.others$desc <- paste0("roche: ", roches.others$idroche)
leaflet(width = "900px", height = "900px") %>%
  addTiles(group = 'OSM') %>%
  addProviderTiles("Esri.WorldImagery", group = "Ortho") %>%
  addCircleMarkers(data = roches.others,
                   lng = ~x,
                   lat = ~y,
                   popup = ~desc,
                   radius = 0.5,
                   opacity = 0.8) %>%
  addMarkers(data = roches.3D,
             lng = ~x,
             lat = ~y,
             popup = ~desc,
             icon = roches.3D.icons) %>%
  addLayersControl(
    baseGroups = c('Ortho', 'OSM')) %>%
  addScaleBar(position = "bottomleft")
```
